# WebSocket Optimization - –£–º–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

## üéØ –¶–µ–ª—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–°–¥–µ–ª–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π: **–æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ WebSocket —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**.

---

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π** (`socket_events.py`)

–î–æ–±–∞–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º:

```python
active_company_connections = {
    'company_id_1': {'session_id_1', 'session_id_2', ...},
    'company_id_2': {'session_id_3', ...},
}
```

### 2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏**

- **–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏** (`join_company`): –¥–æ–±–∞–≤–ª—è–µ–º session_id –≤ —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–∏
- **–ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏** (`disconnect`, `leave_company`): —É–¥–∞–ª—è–µ–º session_id –∏ –æ—á–∏—â–∞–µ–º –∫–æ–º–ø–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –±–æ–ª—å—à–µ –Ω–µ—Ç

### 3. **–ù–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π**

```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏
has_active_connections(company_id) -> bool

# –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
get_active_companies() -> list

# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
get_active_connections_count(company_id=None) -> int
```

### 4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è broadcast —Ñ—É–Ω–∫—Ü–∏–π**

–§—É–Ω–∫—Ü–∏–∏ `broadcast_container_update()` –∏ `broadcast_location_update()` —Ç–µ–ø–µ—Ä—å:
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π **–ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π**
- **–ü—Ä–æ–ø—É—Å–∫–∞—é—Ç** –æ—Ç–ø—Ä–∞–≤–∫—É, –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
- –õ–æ–≥–∏—Ä—É—é—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

### 5. **–£–º–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä –¥–∞—Ç—á–∏–∫–æ–≤** (`sensor_simulator.py`)

–°–∏–º—É–ª—è—Ç–æ—Ä —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ **—Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è**, –∫–æ–≥–¥–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:

```
[IDLE] No active WebSocket connections for EcoTracker company
       Waiting for users to connect... (checking every 10 seconds)
```

–ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:

```
[ACTIVE] 2 WebSocket connection(s) detected for EcoTracker
===========================================================
STAGE 1/6: 1 full, 1 partial, 1 empty
Updating EcoTracker locations...
```

---

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### **1. –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤**
- ‚ùå **–†–∞–Ω—å—à–µ**: —Å–∏–º—É–ª—è—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–ª 24/7, –æ–±–Ω–æ–≤–ª—è–ª –ë–î –∏ –ø—ã—Ç–∞–ª—Å—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–∞–∂–µ –±–µ–∑ –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ **–¢–µ–ø–µ—Ä—å**: —Å–∏–º—É–ª—è—Ç–æ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è, –ø—Ä–æ–≤–µ—Ä—è—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

### **2. –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î**
- ‚ùå **–†–∞–Ω—å—à–µ**: ~6 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ = 51,840 –æ–ø–µ—Ä–∞—Ü–∏–π/—Å—É—Ç–∫–∏
- ‚úÖ **–¢–µ–ø–µ—Ä—å**: –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç

### **3. –ú–µ–Ω—å—à–µ –ª–æ–≥–æ–≤**
- ‚ùå **–†–∞–Ω—å—à–µ**: —Ç—ã—Å—è—á–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ broadcast –±–µ–∑ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- ‚úÖ **–¢–µ–ø–µ—Ä—å**: –ª–æ–≥–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

### **4. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**
- –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ —Å **–Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏**
- –ö–∞–∂–¥–∞—è –∫–æ–º–ø–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

---

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```
[10:00:00] –°–∏–º—É–ª—è—Ç–æ—Ä: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...
           -> 0 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
           -> –†–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è 10 —Å–µ–∫—É–Ω–¥
           
[10:00:10] –°–∏–º—É–ª—è—Ç–æ—Ä: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...
           -> 0 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
           -> –†–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è 10 —Å–µ–∫—É–Ω–¥
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ù–∏–∫–∞–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ë–î, –Ω–∏–∫–∞–∫–∏—Ö broadcast

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è

```
[10:01:00] –ö–ª–∏–µ–Ω—Ç: connect -> join_company('company_123')
           Socket: –î–æ–±–∞–≤–ª–µ–Ω –≤ active_company_connections['company_123']
           
[10:01:05] –°–∏–º—É–ª—è—Ç–æ—Ä: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...
           -> 1 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è company_123
           -> –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π!
           
[10:01:05] Stage 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...
           Broadcast: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö 1 –∫–ª–∏–µ–Ω—Ç—É
           
[10:01:15] Stage 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...
           Broadcast: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö 1 –∫–ª–∏–µ–Ω—Ç—É
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–¥—É—Ç, –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è

```
[10:02:30] –ö–ª–∏–µ–Ω—Ç: disconnect
           Socket: –£–¥–∞–ª–µ–Ω –∏–∑ active_company_connections['company_123']
           Socket: –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç -> —É–¥–∞–ª—è–µ–º company_123
           
[10:02:35] –°–∏–º—É–ª—è—Ç–æ—Ä: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...
           -> 0 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
           -> –í–æ–∑–≤—Ä–∞—Ç –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°–∏–º—É–ª—è—Ç–æ—Ä –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

## üöÄ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–†–∞–∑–ª–∏—á–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π
2. **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è** –∫–æ–º–ø–∞–Ω–∏–π —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
3. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è WebSocket –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
4. **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª** –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (—Å–µ–π—á–∞—Å 10 —Å–µ–∫—É–Ω–¥)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: `python app.py`
2. –ù–∞–±–ª—é–¥–∞–π—Ç–µ –ª–æ–≥: `[IDLE] No active WebSocket connections...`
3. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–ª–∏–µ–Ω—Ç –∏ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å
4. –ù–∞–±–ª—é–¥–∞–π—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥: `[ACTIVE] 1 WebSocket connection(s) detected`
5. –ó–∞–∫—Ä–æ–π—Ç–µ –∫–ª–∏–µ–Ω—Ç
6. –ù–∞–±–ª—é–¥–∞–π—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç: `[IDLE] No active WebSocket connections...`

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω (Render)

–ù–∞ Render —Å–∏–º—É–ª—è—Ç–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **–æ—Ç–∫–ª—é—á–µ–Ω**. –î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è:
1. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è: `ENABLE_SIMULATOR=true`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥**
- –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç **thread-safe** –±–ª–∞–≥–æ–¥–∞—Ä—è `gevent`
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏
- –ò–∑–º–µ–Ω–µ–Ω–∏—è **–ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã** —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º

---

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: 14 –æ–∫—Ç—è–±—Ä—è 2025
**–ê–≤—Ç–æ—Ä**: EcoTracker Development Team

