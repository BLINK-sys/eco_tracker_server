# üéØ –£–º–Ω—ã–µ FCM –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## –ü—Ä–æ–±–ª–µ–º–∞
–†–∞–Ω—å—à–µ –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏/–æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–ª **–í–°–ï** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –¥–æ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞. –≠—Ç–æ –±—ã–ª–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ –∏ —Ä–∞–∑–¥—Ä–∞–∂–∞–ª–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## –†–µ—à–µ–Ω–∏–µ
–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **–¢–û–õ–¨–ö–û –ù–û–í–´–ï** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Äî —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—è–≤–∏–ª–∏—Å—å **–ü–û–°–õ–ï** —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–≤–µ—Ä–Ω—É–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

---

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**
–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ –ø–æ–ª–µ `last_seen_at` –≤ —Ç–∞–±–ª–∏—Ü—É `fcm_tokens`:
```sql
ALTER TABLE fcm_tokens 
ADD COLUMN IF NOT EXISTS last_seen_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;
```

### 2. **API Heartbeat**
–ù–æ–≤—ã–π endpoint `/api/fcm/heartbeat`:
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ **–≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** (–ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω)
- –û–±–Ω–æ–≤–ª—è–µ—Ç `last_seen_at` –¥–ª—è FCM —Ç–æ–∫–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç: "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ–º—É —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"

### 3. **–õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ FCM**
–í `fcm_service.py`:
```python
def send_container_notification(container_data, location_data, container_updated_at=None):
    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–≤–µ—Ä—è–µ–º:
    if token_obj.last_seen_at < container_updated_at:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        # ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    else:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ñ–ï –≤–∏–¥–µ–ª —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        # ‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### 4. **–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ª–æ–≥–∏–∫–∞**
–í –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:
- –ü—Ä–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ (`AppLifecycleState.resumed`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `sendHeartbeat()`
- –°–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç `last_seen_at`
- –í—Å–µ –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã

---

## üìä –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω
```
12:00 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–∏–ª—Å—è (last_seen_at = 12:00)
12:05 - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø–æ–ª–Ω–∏–ª—Å—è (updated_at = 12:05)
12:05 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –û–¢–ö–†–´–õ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí heartbeat ‚Üí last_seen_at = 12:05
12:10 - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø–æ–ª–Ω–∏–ª—Å—è (updated_at = 12:10)
      ‚Üí last_seen_at (12:05) < updated_at (12:10)
      ‚Üí ‚úÖ –û–¢–ü–†–ê–í–õ–Ø–ï–ú —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–≤–µ—Ä–Ω—É–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```
12:00 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–∏–ª—Å—è (last_seen_at = 12:00)
12:05 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–í–ï–†–ù–£–õ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
12:10 - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø–æ–ª–Ω–∏–ª—Å—è (updated_at = 12:10)
      ‚Üí last_seen_at (12:00) < updated_at (12:10)
      ‚Üí ‚úÖ –û–¢–ü–†–ê–í–õ–Ø–ï–ú —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
12:15 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –û–¢–ö–†–´–õ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí heartbeat ‚Üí last_seen_at = 12:15
12:20 - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø–æ–ª–Ω–∏–ª—Å—è (updated_at = 12:20)
      ‚Üí last_seen_at (12:15) < updated_at (12:20)
      ‚Üí ‚úÖ –û–¢–ü–†–ê–í–õ–Ø–ï–ú —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
```
12:00 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–∏–ª—Å—è (last_seen_at = 12:00)
12:05 - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä A –∑–∞–ø–æ–ª–Ω–∏–ª—Å—è (updated_at = 12:05)
12:10 - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä B –∑–∞–ø–æ–ª–Ω–∏–ª—Å—è (updated_at = 12:10)
12:15 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–í–ï–†–ù–£–õ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (last_seen_at –≤—Å—ë –µ—â—ë 12:00!)
      ‚Üí –ù–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã A –∏ B –±—ã–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –†–ê–ù–¨–®–ï last_seen_at
      ‚Üí ‚è≠Ô∏è –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Ö —É–∂–µ –≤–∏–¥–µ–ª!)
12:20 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –û–¢–ö–†–´–õ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí heartbeat ‚Üí last_seen_at = 12:20
12:25 - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä C –∑–∞–ø–æ–ª–Ω–∏–ª—Å—è (updated_at = 12:25)
      ‚Üí last_seen_at (12:20) < updated_at (12:25)
      ‚Üí ‚úÖ –û–¢–ü–†–ê–í–õ–Ø–ï–ú —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è C!
```

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –û–±–Ω–æ–≤–∏—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –Ω–∞ Render (PostgreSQL Console):
```bash
cd ecotracker_server
cat add_last_seen_column.sql
```

–ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ:
```bash
psql -d ecotracker -f add_last_seen_column.sql
```

### 2. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ —Å–µ—Ä–≤–µ—Ä–∞
```bash
git add .
git commit -m "Add smart FCM notifications with last_seen_at"
git push
```

### 3. –û–±–Ω–æ–≤–∏—Ç–µ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
Heartbeat –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** ‚Üí –∑–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å
2. **–°–≤–µ—Ä–Ω–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** (–Ω–∞–∂–º–∏—Ç–µ Home)
3. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ** –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è (—Å–∏–º—É–ª—è—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç)
4. **–ü–æ–ª—É—á–∏—Ç–µ PUSH —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** üì±
5. **–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** ‚Üí heartbeat –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
6. **–°–Ω–æ–≤–∞ —Å–≤–µ—Ä–Ω–∏—Ç–µ** ‚Üí –±–æ–ª—å—à–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –±—É–¥–µ—Ç (–ø–æ–∫–∞ –Ω–µ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)

---

## üìù –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –°–µ—Ä–≤–µ—Ä (fcm_service.py):
```
üì± –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å user@example.com –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω —Å 2025-01-01 12:00:00, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
‚è≠Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å user2@example.com –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –≤ 2025-01-01 12:30:00, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### –ö–ª–∏–µ–Ω—Ç (auth_provider.dart):
```
üíì –û—Ç–ø—Ä–∞–≤–ª—è–µ–º heartbeat –ø—Ä–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...
üîÑ Heartbeat –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, last_seen_at –æ–±–Ω–æ–≤–ª–µ–Ω
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ù–µ—Ç —Å–ø–∞–º–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **–£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞**: –°–∏—Å—Ç–µ–º–∞ –∑–Ω–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–∏–¥–µ–ª
- **–≠–∫–æ–Ω–æ–º–∏—è**: –ú–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Firebase
- **UX**: –õ—É—á—à–∏–π –æ–ø—ã—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## üîç –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `last_seen_at` –≤ –±–∞–∑–µ: `SELECT * FROM fcm_tokens;`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `updated_at` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: `SELECT * FROM containers WHERE id = '...';`
3. –°—Ä–∞–≤–Ω–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–∞: `last_seen_at` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å **–ú–ï–ù–¨–®–ï** `updated_at`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è FCM

